<body>
<div class="bg-overlay"></div>

<header>
    <div style="font-family: 'Montserrat'; font-weight: 800; color: var(--navy); font-size: 1.1rem;">VV HOME PRO</div>
    <nav class="nav-links">
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})">Home</button>
        <button onclick="document.getElementById('about-section').scrollIntoView({behavior: 'smooth'})">About Us</button>
        <button class="pro-link-btn" onclick="document.getElementById('pro-section').scrollIntoView({behavior: 'smooth'})">Pro Directory</button>
    </nav>
</header>

<main class="container">
    <div class="side-panel" id="about-section">
        <h2 style="font-family:'Montserrat'; color:var(--navy); margin-top:0;">The V&V Standard</h2>
        <p>Connecting Ontario with <strong>Vetted & Verified</strong> professionals.</p>
        <div style="background: var(--navy); color:white; padding: 15px; border-radius: 8px; font-size: 0.8rem; line-height: 1.6;">
            • Verified WSIB & Liability<br>
            • Secure Intake Receipt<br>
            • Encrypted Transmission
        </div>
    </div>

    <div class="chat-card">
        <div class="chat-header">VV HOME PRO MATCHING PORTAL</div>
        <div id="chat-window">
            <div class="msg bot">Welcome to VV HOME PRO. Briefly describe the project you need completed (e.g. Roofing, HVAC, Windows).</div>
        </div>
        <div class="input-bar">
            <input type="text" id="user-input" placeholder="Type here..." onkeypress="if(event.key==='Enter') send()">
            <button id="send-btn" onclick="send()">SEND</button>
        </div>
    </div>
</main>

<div id="pro-section">
    <h2 style="font-family:'Montserrat'; color:var(--navy); margin-top:0;">For Home Pro Professionals</h2>
    <p>Are you a high-quality contractor? Join the VV HOME PRO directory to increase your exposure and build trust with vetted credentials.</p>
    <button style="background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 4px; font-weight: 700; cursor: pointer; margin-top: 15px;">Apply to Join Directory</button>
</div>

<script>
    const WORKER = 'https://vvhomepro-brain.dbelnavis.workers.dev/'; 
    let chatHistory = [];

    async function send() {
        const input = document.getElementById('user-input');
        const val = input.value.trim();
        if(!val) return;
        const box = document.getElementById('chat-window');

        // CHECK FOR CONFIRMATION LOGIC
        if(val.toLowerCase() === 'confirm') {
            box.innerHTML += `<div class="msg user">${val}</div>`;
            const successMsg = document.createElement('div');
            successMsg.className = 'msg bot';
            successMsg.style.backgroundColor = '#e8f5e9';
            successMsg.style.borderLeft = '4px solid #2e7d32';
            successMsg.innerHTML = `<strong>✅ REQUEST VERIFIED</strong><br>We are now matching your project with local V&V Pros. You will receive a secure intake receipt via SMS shortly.`;
            box.appendChild(successMsg);
            input.value = '';
            box.scrollTop = box.scrollHeight;
            return;
        }

        box.innerHTML += `<div class="msg user">${val}</div>`;
        chatHistory.push({ role: "user", parts: [{ text: val }] });
        input.value = '';
        
        const load = document.createElement('div');
        load.className = 'msg bot';
        load.innerText = 'Syncing with V&V Engine...';
        box.appendChild(load);
        box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch(WORKER, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: chatHistory, 
                    // Simplified instruction to avoid parsing errors
                    system_instruction: { parts: [{ text: "You are the VV HOME PRO assistant. Greet the user, then collect: 1. Project, 2. Name, 3. City, 4. Phone, 5. Time. Summarize and ask for CONFIRM." }] } 
                })
            });

            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            const aiText = data.candidates[0].content.parts[0].text;
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            load.innerHTML = marked.parse(aiText);
            
            if(aiText.toUpperCase().includes("REVIEW")) {
                load.classList.add('summary-mode');
            }
        } catch (e) {
            load.innerHTML = `<span style="color:red; font-weight:bold;">⚠️ Connection Error:</span><br><small>${e.message}</small>`;
        }
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
